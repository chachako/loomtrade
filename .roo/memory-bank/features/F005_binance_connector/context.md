# Feature Context: 币安合约市场接口 (Binance Futures Connector) (ID: F005_binance_connector)
*Initialized by Feature-Lead on 2025-05-10 11:32:53*

## 1. Overview & Goal
本功能的核心目标是实现一个 ExchangeConnector 模块，该模块专门用于与币安 (Binance) 的合约市场 API 进行交互。
主要功能需求包括：
1.  安全地处理 API 密钥和认证。
2.  获取市场数据：如 K 线 (OHLCV)、最新价格、订单簿深度、资金费率等。
3.  订单管理：下达限价单、市价单、止损/止盈单；查询订单状态；取消订单。
4.  账户信息：查询账户余额、持仓情况。
5.  错误处理与重试机制：妥善处理 API 返回的各种错误，并实现合理的重试逻辑。
该模块是系统与实际交易市场连接的桥梁，其稳定性和可靠性至关重要。
*(详细目标：创建一个健壮、可靠且安全的 Python 模块，作为币安 USDT 本位合约 API 的接口，为其他系统组件（主要是分析师和交易员代理）提供程序化交易操作和市场数据检索功能。)*

## 2. Detailed Requirements / User Stories
### 2.1 API Key Management
*   **User Story 1:** 作为一名系统管理员，我希望能够安全地配置和存储币安 API 密钥，以便交易员代理可以通过连接器模块授权访问币安合约市场。
    *   **Acceptance Criterion 1.1:** 假定提供了 API 密钥（API Key 和 Secret Key），当连接器模块初始化时，那么这些密钥应被安全存储（例如，加密或通过安全的环境变量加载）。
    *   **Acceptance Criterion 1.2:** 假定 API 密钥已安全加载，当连接器向币安 API 发出请求时，那么请求头必须包含正确的认证签名。
    *   **Acceptance Criterion 1.3:** 假定提供了无效的 API 密钥，当连接器尝试认证时，那么应返回一个清晰的认证失败错误，并且不应继续任何市场操作。

### 2.2 Market Data Retrieval
*   **User Story 2:** 作为一名分析师代理，我希望能通过连接器模块从币安合约市场检索指定交易对、时间间隔和数量限制的 K 线数据 (OHLCV)，以便我能执行市场分析。
    *   **Acceptance Criterion 2.1:** 假定指定了有效的交易对（例如 BTCUSDT）、时间间隔（例如 1h）和数量限制（例如 100），当请求 K 线数据时，那么连接器应返回一个结构化的 K 线数据列表，其中包含相应数量的蜡烛图，每条均含开盘价、最高价、最低价、收盘价和成交量。
    *   **Acceptance Criterion 2.2:** 假定请求了不存在的交易对或无效的时间间隔，当请求 K 线数据时，那么连接器应返回一个清晰的错误消息，指明请求参数无效。
    *   **Acceptance Criterion 2.3:** 假定由于速率限制导致币安 API 暂时不可用，当请求 K 线数据时，那么连接器应根据预定义的重试策略进行重试，并在多次失败后返回适当的错误。

### 2.3 Order Management
*   **User Story 3:** 作为一名交易员代理，我希望能通过连接器模块在币安合约市场为指定的交易对、价格和数量下达限价单 (LIMIT order)，以便我能在特定价格水平执行交易。
    *   **Acceptance Criterion 3.1:** 假定指定了有效的交易对、方向（买/卖）、数量和价格，当下达限价单时，那么连接器应成功将订单请求发送至币安 API，并返回包含订单 ID 和初始状态（例如 NEW）的确认信息。
    *   **Acceptance Criterion 3.2:** 假定账户余额不足或未满足保证金要求，当下达限价单时，那么连接器应返回一个清晰的错误消息，指明失败原因（例如，余额不足）。
    *   **Acceptance Criterion 3.3:** 假定订单参数无效（例如，价格精度不正确，数量过小），当下达限价单时，那么连接器应返回币安 API 提供的特定错误消息。

## 3. Acceptance Criteria
*(验收标准现已整合到第 2 节的每个用户故事中。)*

## 4. Scope
### 4.1. In Scope:
*   币安 USDT 本位合约 (永续合约)。
*   使用币安官方 API V1 (`https://fapi.binance.com`)。
*   核心功能：安全认证，检索 K 线/最新价/订单簿深度/资金费率，下达限价单 (LIMIT)/市价单 (MARKET)/止损市价单 (STOP_MARKET)/止盈市价单 (TAKE_PROFIT_MARKET) 订单，查询订单状态/账户余额/持仓，错误处理和重试机制。
*   日志记录：记录关键的 API 请求、响应和错误。
### 4.2. Out of Scope:
*   币本位合约。
*   现货交易。
*   期权交易。
*   实时订阅 WebSocket 数据流（初期重点是 REST API；WebSocket 可作为后续增强功能）。
*   复杂的本地订单类型组合逻辑（例如，本地实现的 OCO 订单，除非币安 API 直接支持）。
*   用于管理连接器的用户界面 (UI)。

## 5. Technical Notes / Assumptions
*   假设必要的 Python 库（例如 `requests`，如果使用 `python-binance`，或者在直接调用 API 时用于签名的自定义逻辑）已安装在操作环境中。
*   API 密钥将通过安全方式（例如，环境变量或加密的配置文件）提供给连接器模块。
*   将严格遵守币安 API 的速率限制。
*   与币安 API 的所有交互都将通过 HTTPS 进行。
*   错误处理将区分可重试错误（例如，网络问题、速率限制）和不可重试错误（例如，无效参数、认证失败）。